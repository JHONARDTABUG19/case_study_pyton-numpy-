import csv
import os
import statistics
import analytics  # your existing weighted.py module
import array_operations # select, project, sort, insert, delete
from ingest import clean_ingest # read csv file and validate rows
import reports
import at_risk  # âœ… new module

# ----------------------
# Configuration
# ----------------------
# File name for the CSV database
FILENAME = "ano.csv"

# Column names for the student data
HEADER = [
    "student_id",
    "last_name",
    "first_name",
    "section",
    "quiz1",
    "quiz2",
    "quiz3",
    "quiz4",
    "quiz5",
    "midterm",
    "final",
    "attendance_percent"
]



valid_rows, _ = array_operations.clean_ingest("ano.csv", HEADER) # calls the clean_ingest function


# ----------------------
# Main Menu
# ----------------------
def menu():
    """
    Main menu function that displays options and handles user choices.
    Runs in an infinite loop until user chooses to exit.
    """
    while True:
        # Display all menu options
        print("\n=== STUDENT CSV MENU ===")
        print("1. Add and Save Student(s)")
        print("2. Read CSV File")
        print("3. Delete Student by ID")
        print("4. Select Header column")
        print("5. Project Student Record by Student ID")
        print("6. Sort Student Data") # New option
        print("7. Analytics and Reports") # Shifted to 7
        print("8. Exit") # Shifted to 8

        # Get user input and remove extra spaces
        choice = input("Enter choice: ").strip()

        # Option 1: Add new student records to the CSV file
        if choice == "1":
            array_operations.add_data()
        elif choice == "2":
            valid_rows, _ = array_operations.clean_ingest()
            if valid_rows:
                print("\nðŸ“˜ Valid rows:")
                for row in valid_rows:
                    print(row)
        
        # Option 3: Remove a student record by their ID
        elif choice == "3":
            array_operations.delete_data()
        elif choice == "4":
            array_operations.select_column()
        elif choice == "5":
            array_operations.select_row()
        elif choice == "6": # New call for sorting
            array_operations.sort_data()
        elif choice == "7":
            while True:
                print("\n=== ANALYTICS AND REPORTS MENU ===")
                print("a. Compute Weighted Grades")
                print("b. Grade Distribution (Aâ€“F)")
                print("c. Percentiles (Top/Bottom 10%)")
                print("d. Outlier Detection (Â±2 SD)")
                print("e. Improvement (Final vs Midterm)")
                print("f. Summary Report")
                print("g. At-Risk Students (Export CSV)")  # âœ… NEW
                print("h. Back to Main Menu")

                sub = input("Select an option (aâ€“h): ").lower().strip()

                if sub == "a":
                    analytics.compute_grades()
                elif sub == "b":
                    analytics.grade_distribution()
                elif sub == "c":
                    analytics.percentiles()
                elif sub == "d":
                    analytics.outliers()
                elif sub == "e":
                    analytics.improvement()
                elif sub == "f":
                    reports.summary_report()
                elif sub == "g":
                    at_risk.export_at_risk()  # âœ… new call
                elif sub == "h":
                    break
                else:
                    print("Invalid choice. Please try again.")




# ----------------------
# Run Program
# ----------------------
# Start the program by calling the menu function
menu()

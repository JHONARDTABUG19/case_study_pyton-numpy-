import csv
import os
from ingest import clean_ingest

FILENAME = "ano.csv"
HEADER = [
    "student_id",
    "last_name",
    "first_name",
    "section",
    "quiz1",
    "quiz2",
    "quiz3",
    "quiz4",
    "quiz5",
    "midterm",
    "final",
    "attendance_percent"
]

def save_to_csv(data, filename=FILENAME):
    file_exists = os.path.exists(filename)
    with open(filename, "a", newline="", encoding="utf-8") as f:
        writer = csv.writer(f)
        if not file_exists:
            writer.writerow(HEADER)
        writer.writerows(data)
    print(f"üíæ Data saved to {filename}")

def save_cleaned_csv(valid_rows, filename=FILENAME):
    with open(filename, "w", newline="", encoding="utf-8") as f:
        writer = csv.writer(f)
        writer.writerow(HEADER)
        writer.writerows(valid_rows)
    print(f"üíæ Cleaned data saved to {filename}")

def delete_data(filename=FILENAME):
    if not os.path.exists(filename):
        print("‚ö†Ô∏è File not found.")
        return

    student_id = input("Enter student_id to delete: ")
    valid_rows, _ = clean_ingest(filename, HEADER)
    updated_rows = [row for row in valid_rows if row[0] != student_id]

    if len(updated_rows) == len(valid_rows):
        print("‚ùå No student found with that ID.")
        return

    save_cleaned_csv(updated_rows)
    print(f"üóëÔ∏è Deleted student_id {student_id} successfully.")

def select_column(filename=FILENAME):
    valid_rows, _ = clean_ingest(filename, HEADER)
    if not valid_rows:
        print("‚ö†Ô∏è No valid data.")
        return

    print("\nAvailable columns:")
    for i, col in enumerate(HEADER):
        print(f"{i+1}. {col}")

    col_name = input("Enter column name to view: ").strip()
    if col_name not in HEADER:
        print("‚ùå Invalid column name.")
        return

    index = HEADER.index(col_name)
    print(f"\nüìä Values under '{col_name}':")
    for row in valid_rows:
        print(row[index])

def select_row(filename=FILENAME):
    valid_rows, _ = clean_ingest(filename, HEADER)
    if not valid_rows:
        print("‚ö†Ô∏è No valid data.")
        return

    student_id = input("Enter student_id to view: ")
    for row in valid_rows:
        if row[0] == student_id:
            print("\nüìã Student Information:")
            for h, v in zip(HEADER, row):
                print(f"{h}: {v}")
            return

    print("‚ùå No student found with that ID.")

def sort_data(filename=FILENAME):
    valid_rows, _ = clean_ingest(filename, HEADER)
    if not valid_rows:
        print("‚ö†Ô∏è No valid data to sort.")
        return

    print("\nüî¢ Available columns to sort by:")
    for i, col in enumerate(HEADER):
        print(f"{i+1}. {col}")

    col_name = input("\nEnter column name to sort by: ").strip()
    if col_name not in HEADER:
        print("‚ùå Invalid column name.")
        return

    col_index = HEADER.index(col_name)

    print("\nSort order:")
    print("1. Ascending (A‚ÜíZ, 0‚Üí100)")
    print("2. Descending (Z‚ÜíA, 100‚Üí0)")
    order = input("Enter choice (1 or 2): ").strip()
    reverse = True if order == "2" else False

    is_numeric = col_index in range(4, 12)

    def sort_key(row):
        value = row[col_index]
        if is_numeric:
            if value is None:
                return float('-inf') if not reverse else float('inf')
            return float(value)
        else:
            if value is None or str(value).lower() == "none":
                return ""
            return str(value).lower()

    try:
        sorted_rows = sorted(valid_rows, key=sort_key, reverse=reverse)
        save_cleaned_csv(sorted_rows, filename)

        print(f"\n‚úÖ Data sorted by '{col_name}' ({'descending' if reverse else 'ascending'})")
        print("\nüìã Preview (first 10 rows):")
        print("-" * 100)
        print(f"{'ID':<12} {'Last Name':<15} {'First Name':<15} {'Section':<10} {col_name:<15}")
        print("-" * 100)
        for row in sorted_rows[:10]:
            display_val = row[col_index] if row[col_index] is not None else "N/A"
            print(f"{row[0]:<12} {row[1]:<15} {row[2]:<15} {row[3]:<10} {str(display_val):<15}")
        if len(sorted_rows) > 10:
            print(f"\n... and {len(sorted_rows) - 10} more rows")
    except Exception as e:
        print(f"‚ùå Error during sorting: {e}")

if __name__ == "__main__":
    valid, bad = clean_ingest(FILENAME, HEADER)
    print(f"Loaded {len(valid)} valid rows and {len(bad)} bad rows from {FILENAME}.")
